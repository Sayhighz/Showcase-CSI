# .htaccess for Node.js backend on cPanel with reverse proxy
# Path: /csie/backend2

# Prevent direct access to .env and other sensitive files
<FilesMatch "^\.env">
    Order allow,deny
    Deny from all
</FilesMatch>

# Prevent access to node_modules
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteRule ^node_modules/ - [F,L]
    RewriteRule ^src/ - [F,L]
    RewriteRule ^migrations/ - [F,L]
    RewriteRule ^\.git/ - [F,L]
</IfModule>

# Set proper headers for proxy (CORS for /csie/backend2)
<IfModule mod_setenvif.c>
    # Mark requests under the API path and preflight method
    SetEnvIfNoCase Request_URI "^/csie/backend2/" IS_CSIE=1
    SetEnvIfNoCase Request_Method "OPTIONS" IS_PREFLIGHT=1
</IfModule>

<IfModule mod_headers.c>
    # CORS: must be explicit origin when credentials=true
    Header always set Access-Control-Allow-Origin "https://www.sitspu.com" env=IS_CSIE
    Header always set Access-Control-Allow-Credentials "true" env=IS_CSIE
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" env=IS_CSIE

    # Ensure no stale A-C-A-Headers from upstream; then set and merge required values
    Header always unset Access-Control-Allow-Headers env=IS_CSIE
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, secret_key, admin_secret_key, x-admin-client, Accept, Origin, Cache-Control" env=IS_CSIE
    # Merge to guarantee presence even if server injects its own list
    Header always merge Access-Control-Allow-Headers "x-admin-client" env=IS_CSIE
    Header always merge Access-Control-Allow-Headers "secret_key" env=IS_CSIE
    Header always merge Access-Control-Allow-Headers "admin_secret_key" env=IS_CSIE

    Header always set Access-Control-Max-Age "86400" env=IS_CSIE
    Header always set Vary "Origin" env=IS_CSIE

    # Preflight responses should be empty with correct headers
    Header always set Content-Length "0" env=IS_PREFLIGHT
    Header always set Content-Type "text/plain; charset=utf-8" env=IS_PREFLIGHT

    # Security headers (apply globally)
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"

    # Remove server signature
    Header unset Server
    Header unset X-Powered-By
</IfModule>

# Short-circuit OPTIONS preflight for /csie/backend2 with 204
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} =OPTIONS
    RewriteCond %{REQUEST_URI} ^/csie/backend2/
    RewriteRule ^ - [R=204,L]
</IfModule>

# Proxy configuration for Node.js app
<IfModule mod_proxy.c>
    # Enable proxy modules
    ProxyRequests Off
    ProxyPreserveHost On
    
    # Set timeout values to prevent 503 errors
    ProxyTimeout 30
    ProxyBadHeader Ignore
    
    # Forward requests to Node.js app running on port 4000
    ProxyPass /csie/backend2 http://127.0.0.1:4000/csie/backend2 retry=0 timeout=30 keepalive=On
    ProxyPassReverse /csie/backend2 http://127.0.0.1:4000/csie/backend2
    
    # Handle WebSocket connections if needed
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://127.0.0.1:4000/$1" [P,L]
</IfModule>

# Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
</IfModule>

# Cache static files
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Images
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 month"
    
    # Video
    ExpiresByType video/mp4 "access plus 1 month"
    ExpiresByType video/mpeg "access plus 1 month"
    ExpiresByType video/webm "access plus 1 month"
    
    # CSS, JavaScript
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType text/javascript "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
    
    # Others
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType application/x-shockwave-flash "access plus 1 month"
</IfModule>

# Error handling
ErrorDocument 503 "Service Temporarily Unavailable. Please try again later."
ErrorDocument 502 "Bad Gateway. The backend server is not responding."
ErrorDocument 504 "Gateway Timeout. The request took too long to process."